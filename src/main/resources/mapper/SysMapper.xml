<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.liuliang.quickdinesysstore.mapper.SysMapper">

    <select id="getIntegralRatio" resultType="java.lang.Integer">
        SELECT t_sys.`proportion_integral` FROM t_sys WHERE t_sys.`id` = 1
    </select>
    <update id="updateIntegralRatio">
        UPDATE t_sys SET t_sys.`proportion_integral` = #{integralRatio} WHERE t_sys.`id` = 1
    </update>

    <sql id="findCondition">
        <where>
            <if test="per == 1 and level == 1">
                AND 1=1
            </if>
            <if test="per == 1 and level == 2">
                AND user_info_id = '1321703619577257986'
            </if>
            <if test="per == 1 and level == 3">
                AND user_info_id = '1321703632667680770'
            </if>
            <if test="per == 1 and level == 4">
                AND user_info_id = '1321703592666603521'
            </if>
            <if test="per == 2 and level == 1">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; create_time
                AND create_time &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
            </if>
            <if test="per == 2 and level == 2">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; create_time
                AND create_time &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
                AND user_info_id = '1321703619577257986'
            </if>
            <if test="per == 2 and level == 3">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; create_time
                AND create_time &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
                AND user_info_id = '1321703632667680770'
            </if>
            <if test="per == 2 and level == 4">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; create_time
                AND create_time &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
                AND user_info_id = '1321703592666603521'
            </if>
            <if test="weekPer != 8">
                AND WEEKDAY(create_time) + 1 = #{weekPer}
            </if>
        </where>
    </sql>

    <select id="getUserData" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_user_login
        <include refid="findCondition"></include>
    </select>

    <select id="getDiscussData" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_evaluate
        <include refid="findCondition"></include>
    </select>


    <sql id="orderFindCondition">
        <where>
            <if test="per == 1 and level == 1">
                AND 1=1
            </if>
            <if test="per == 1 and level == 2">
                AND t_user_login.`user_info_id` = '1321703619577257986'
            </if>
            <if test="per == 1 and level == 3">
                AND t_user_login.`user_info_id` = '1321703632667680770'
            </if>
            <if test="per == 1 and level == 4">
                AND t_user_login.`user_info_id` = '1321703592666603521'
            </if>
            <if test="per == 2 and level == 1">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; t_order.`create_time`
                AND t_order.`create_time` &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
            </if>
            <if test="per == 2 and level == 2">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; t_order.`create_time`
                AND t_order.`create_time` &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
                AND t_user_login.`user_info_id`= '1321703619577257986'
            </if>
            <if test="per == 2 and level == 3">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; t_order.`create_time`
                AND t_order.`create_time` &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
                AND t_user_login.`user_info_id` = '1321703632667680770'
            </if>
            <if test="per == 2 and level == 4">
                AND STR_TO_DATE(#{startTime}, '%Y-%m-%d') &lt; t_order.`create_time`
                AND t_order.`create_time` &lt; STR_TO_DATE(#{endTime}, '%Y-%m-%d')
                AND t_user_login.`user_info_id` = '1321703592666603521'
            </if>
            <if test="weekPer != 8">
                AND WEEKDAY(t_order.`create_time`) + 1 = #{weekPer}
            </if>
        </where>
    </sql>
    <select id="getTransactionData" resultType="java.math.BigDecimal">
        SELECT SUM(t_order.`actual_money`) FROM t_order
        LEFT JOIN t_user_login ON t_user_login.`id` = t_order.`user_id`
        <include refid="orderFindCondition"></include>
    </select>
    <select id="getOrderData" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM t_order
        LEFT JOIN t_user_login ON t_user_login.`id` = t_order.`user_id`
        <include refid="orderFindCondition"></include>
    </select>


</mapper>